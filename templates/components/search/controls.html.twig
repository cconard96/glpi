{#
 # ---------------------------------------------------------------------
 #
 # GLPI - Gestionnaire Libre de Parc Informatique
 #
 # http://glpi-project.org
 #
 # @copyright 2015-2023 Teclib' and contributors.
 # @copyright 2003-2014 by the INDEPNET Development Team.
 # @licence   https://www.gnu.org/licenses/gpl-3.0.html
 #
 # ---------------------------------------------------------------------
 #
 # LICENSE
 #
 # This file is part of GLPI.
 #
 # This program is free software: you can redistribute it and/or modify
 # it under the terms of the GNU General Public License as published by
 # the Free Software Foundation, either version 3 of the License, or
 # (at your option) any later version.
 #
 # This program is distributed in the hope that it will be useful,
 # but WITHOUT ANY WARRANTY; without even the implied warranty of
 # MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 # GNU General Public License for more details.
 #
 # You should have received a copy of the GNU General Public License
 # along with this program.  If not, see <https://www.gnu.org/licenses/>.
 #
 # ---------------------------------------------------------------------
 #}

{% if showmassiveactions and count > 0 %}
    <div class="massiveactions-control card-header search-header position-absolute w-100 animate__animated d-none"
         style="z-index: 1022;">
        {% do call('Html::showMassiveActions', [massiveactionparams]) %}
    </div>
{% endif %}

<div class="card-header d-flex justify-content-between search-header">
    <div class="d-inline-flex search-controls">
        {% set can_select_view = may_be_located %}
        {% if can_select_view %}
            <div class="btn-group me-2" role="group">
                <input type="radio" class="btn-check" role="button"
                    name="as_map" value="1" autocomplete="off"
                    id="show_as_table"
                    onclick="toogle('as_map','','',''); document.forms['searchform{{ itemtype|lower }}'].submit();"
                    {{ data['search']['as_map'] == 0 ? 'checked' : '' }} />
                    <label class="btn btn-sm btn-outline-secondary" title="{{ __('Show as table') }}"
                        for="show_as_table"
                        data-bs-toggle="tooltip" data-bs-placement="bottom">
                        <i class="ti ti-table"></i>
                    </label >

                {% if may_be_located and (count > 0 or data['search']['as_map'] == 1) %}
                    <input type="radio" class="btn-check" role="button"
                        name="as_map" value="1" autocomplete="off"
                        id="show_as_map"
                        onclick="toogle('as_map','','',''); document.forms['searchform{{ itemtype|lower }}'].submit();"
                        {{ data['search']['as_map'] == 1 ? 'checked' : '' }} />
                    <label class="btn btn-sm btn-outline-secondary" title="{{ __('Show as map') }}"
                        for="show_as_map"
                        data-bs-toggle="tooltip" data-bs-placement="bottom">
                        <i class="ti ti-map-2"></i>
                    </label >
                {% endif %}
            </div>
        {% endif %}

        {% if may_be_browsed %}
            <button class="btn btn-sm {{ data['search']['browse'] == 1 ? "btn-secondary" : "btn-ghost-secondary" }} me-2" type="button"
                    title="{{ __('Toggle browse') }}" data-bs-toggle="tooltip" data-bs-placement="bottom"
                    onclick="toogle('browse','','',''); document.forms['searchform{{ itemtype|lower }}'].submit();">
                <i class="ti {{ data['search']['browse'] == 1 ? "ti-checkbox" : "ti-square" }}"></i>
                <span class="d-flex align-bottom">
                    <i class="ti ti-subtask"></i>
                </label>
            </button>
        {% endif %}

        {% if may_be_deleted %}
            <button class="btn btn-sm {{ data['search']['is_deleted'] == 1 ? "btn-danger" : "btn-ghost-danger" }} me-2" type="button"
                    title="{{ __('Show the trashbin') }}" data-bs-toggle="tooltip" data-bs-placement="bottom"
                    onclick="toogle('is_deleted','','',''); document.forms['searchform{{ itemtype|lower }}'].submit();">
                <i class="ti {{ data['search']['is_deleted'] == 1 ? "ti-checkbox" : "ti-square" }}"></i>
                <span class="d-flex align-bottom">
                    <i class="ti ti-trash"></i>
                </label>
            </button>
        {% endif %}

        {% if may_be_unpublished %}
            <button class="btn btn-sm {{ data['search']['unpublished'] == 1 ? "btn-warning" : "btn-ghost-warning" }} me-2" type="button"
                    title="{{ __('Show unpublished') }}" data-bs-toggle="tooltip" data-bs-placement="bottom"
                    onclick="toogle('unpublished','','',''); document.forms['searchform{{ itemtype|lower }}'].submit();">
                <i class="ti {{ data['search']['unpublished'] == 1 ? "ti-checkbox" : "ti-square" }}"></i>
                <span class="d-flex align-bottom">
                    <i class="ti ti-eye-off"></i>
                </label>
            </button>
        {% endif %}

        <div class="btn-group">
            {% set is_filter_active = false %}
            {% if active_savedsearch|length %}
                {% set is_filter_active = true %}
            {% endif %}
            {% set active_filter_class = is_filter_active ? "btn-secondary" : "btn-outline-secondary" %}

            <button type="button" class="btn btn-sm {{ active_filter_class }} show-saved-searches"
                data-itemtype="{{ itemtype }}" title="{{ __('Show saved searches') }}">
                <i class="ti ti-star"></i>
            </button>

            <button class="btn btn-sm {{ active_filter_class }} me-2 dropdown-toggle" type="button"
                    data-bs-toggle="dropdown" data-bs-auto-close="outside">
                {% if active_savedsearch|length %}
                    <span title="{{ __("Search") }}" data-bs-toggle="tooltip" data-bs-placement="bottom">
                        <span>{{ active_savedsearch }}</span>
                    </span>
                {% else %}
                    <i class="ti ti-search"></i>
                    <span>{{ __('Search') }}</span>
                {% endif %}
            </button>
            <div class="dropdown-menu dropdown-menu-card" style="width: max-content">
                {% do call('Glpi\\Search\\Input\\QueryBuilder::showGenericSearch', [itemtype, original_params]) %}
            </div>
        </div>

        <button class="btn btn-sm btn-ghost-secondary dropdown-toggle" type="button" id="dropdown-export-{{ rand }}"
                data-bs-toggle="dropdown" aria-expanded="false" data-bs-popper-config='{"strategy":"fixed"}' data-bs-auto-close="outside">
            <i class="ti ti-dots-vertical"></i>
        </button>
        <div class="dropdown-menu">
            {% if can_config and count > 0 %}
                <button class="dropdown-item show_displaypreference_modal"
                    type="button"
                    title="{{ __('Select default items to show') }}"
                    data-bs-toggle="tooltip" data-bs-placement="bottom">
                    <i class="ti ti-tool"></i>
                    <span> {{ __('Display preferences') }}</span>
                </button>
                <template id="displaypreference_modal_template{{ rand }}">
                    {{ include('components/search/displaypreference_modal.html.twig', {
                    rand: rand,
                    itemtype: itemtype,
                    }) }}
                </template>
            {% endif %}

            {% if count > 0 %}
                <div class="dropdown dropend">
                    <button class="dropdown-item dropdown-toggle" type="button" id="dropdown-export-{{ rand }}"
                        data-bs-toggle="dropdown" aria-expanded="false" data-bs-popper-config='{"strategy":"fixed"}'>
                        <i id="export_dropdown_icon" class="ti ti-file-download"></i>
                        <span> {{ __('Export') }}</span>
                    </button>
                    {% set exporthref = path('/front/report.dynamic.php') ~ "?" ~ {
                        'item_type': itemtype,
                        'sort': sort,
                        'order': order,
                        'start': start,
                    }|url_encode ~ '&' ~ posthref %}
                    <div class="dropdown-menu" style="z-index: 10001" aria-labelledby="dropdown-export-{{ rand }}">
                        <h6 class="dropdown-header">{{ __("Current page") }}</h6>
                        <a class="dropdown-item" href="{{ exporthref ~ '&display_type=' ~ constant('Search::PDF_OUTPUT_LANDSCAPE') }}">
                            <i class="ti ti-file-type-pdf"></i>
                            {{ __('landscape PDF') }}
                        </a>
                        <a class="dropdown-item" href="{{ exporthref ~ '&display_type=' ~ constant('Search::PDF_OUTPUT_PORTRAIT') }}">
                            <i class="ti ti-file-type-pdf"></i>
                            {{ __('portrait PDF') }}
                        </a>
                        <a class="dropdown-item" href="{{ exporthref ~ '&display_type=' ~ constant('Search::SYLK_OUTPUT') }}">
                            <i class="ti ti-file-spreadsheet"></i>
                            {{ __('SLK') }}
                        </a>
                        <a class="dropdown-item" href="{{ exporthref ~ '&display_type=' ~ constant('Search::CSV_OUTPUT') }}">
                            <i class="ti ti-file-type-csv"></i>
                            {{ __('CSV') }}
                        </a>
                        <hr class="dropdown-divider">
                        <h6 class="dropdown-header">{{ __("All pages") }}</h6>
                        <a class="dropdown-item" href="{{ exporthref ~ '&display_type=-' ~ constant('Search::PDF_OUTPUT_LANDSCAPE') }}">
                            <i class="ti ti-file-type-pdf"></i>
                            {{ __('landscape PDF') }}
                        </a>
                        <a class="dropdown-item" href="{{ exporthref ~ '&display_type=-' ~ constant('Search::PDF_OUTPUT_PORTRAIT') }}">
                            <i class="ti ti-file-type-pdf"></i>
                            {{ __('portrait PDF') }}
                        </a>
                        <a class="dropdown-item" href="{{ exporthref ~ '&display_type=-' ~ constant('Search::SYLK_OUTPUT') }}">
                            <i class="ti ti-file-spreadsheet"></i>
                            {{ __('SLK') }}
                        </a>
                        <a class="dropdown-item" href="{{ exporthref ~ '&display_type=-' ~ constant('Search::CSV_OUTPUT') }}">
                            <i class="ti ti-file-type-csv"></i>
                            {{ __('CSV') }}
                        </a>
                        {% if itemtype != 'Stat' %}
                        <hr class="dropdown-divider">
                        <a class="dropdown-item" href="{{ exporthref ~ '&display_type=-' ~ constant('Search::NAMES_OUTPUT') }}" id="copy_names_to_clipboard">
                            <i class="ti ti-copy"></i>
                            {{ __('Copy names to clipboard') }}
                        </a>
                        {% endif %}
                    </div>
                    <script>
                        // Ugly trick to fix z-index context issue by placing our dropdown at the end of the body
                        $("#dropdown-export-{{ rand }}").on("show.bs.dropdown", function() {
                            $(document.body).append($("ul[aria-labelledby=dropdown-export-{{ rand }}]").detach());
                        });
                    </script>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<script type="text/javascript">
$(document).ready(function() {
   $('.show_displaypreference_modal').click(function(e) {
      e.preventDefault();

      // remove old modal
      $('#displayprefence_modal{{ rand }}').remove();

      // create new one
      $('body').append($('#displaypreference_modal_template{{ rand }}').html());
      const modal_el = $('#displaypreference_modal{{ rand }}');
      modal_el.modal('show');
   });

   $("body").on('hide.bs.modal', '#displaypreference_modal{{ rand }}', function() {
      // Try finding a fluid search instance
      const search_display = $('.ajax-container.search-display-data');
      try {
          if (search_display.length === 1 && search_display.data('js_class') !== undefined) {
              // Trigger a reload of just the results
              search_display.data('js_class').view.refreshResults();
          } else {
              // There is no (or multiple) search results, reload the page
              window.location.reload();
          }
      } catch (err) {
          window.location.reload();
      }
   });

   $('.fold-search').change(function(event) {
      var show_search = $(this).is(":checked");

      // hide tooltips (issue maybe ?)
      $('[data-toggle="tooltip"]').tooltip('hide');

      event.preventDefault();
      $.ajax({
         url: '{{ path('/ajax/search.php') }}',
         type: 'POST',
         datatype: 'json',
         data: {
            'action': 'fold_search',
            'show_search': (show_search ? 1 : 0),
         },
         success: function() {
            toggle_fold_search(show_search);

            // scroll to top to display the change
            if (show_search) {
               $("html, body, .search-container").animate({ scrollTop: 0 });
            }
         }
      });
   });

   $('.default-filter').change(function(event) {
      const search_params = new URLSearchParams(window.location.search);
      if (!$(this).is(":checked")) {
          search_params.set('nodefault', '1');
      } else {
          search_params.delete('nodefault');
      }
      window.location.replace('?' + search_params.toString());
   });

   // Callbacks for copy success/failure
   function copy_success() {
      glpi_toast_info(__('Results copied to clipboard'));
      $('#export_dropdown_icon').removeClass('spinner-border spinner-border-sm');
      $('#export_dropdown_icon').addClass('ti-file-download');
   }
   function copy_error() {
      glpi_toast_error(__('Unexpected error'));
      $('#export_dropdown_icon').removeClass('spinner-border spinner-border-sm');
      $('#export_dropdown_icon').addClass('ti-file-download');
   }

   $('#copy_names_to_clipboard').click(function(e) {
      // Get target link
      var link = $(this).find('a').prop('href');

      // Show loading indicator
      $('#export_dropdown_icon').removeClass('ti-file-download');
      $('#export_dropdown_icon').addClass('spinner-border spinner-border-sm');

      // Prevent link from working
      e.preventDefault();

      // Get data using ajax
      $.get(link, function (data) {
         navigator.clipboard.writeText(data).then(copy_success, copy_error);
      }).fail(copy_error);
   });

    // show massive actions control when at least one checkbox is checked
    $('.massive_action_checkbox').change(function() {
        const nb_ma_checked = $('.massive_action_checkbox:checked').length;

        if (nb_ma_checked === 0) {
            $('.massiveactions-control')
                .removeClass('animate__slideInDown')
                .addClass('animate__slideOutUp')
        } else {
            $('.massiveactions-control')
                .removeClass('d-none')
                .removeClass('animate__slideOutUp')
                .addClass('animate__slideInDown');
        }
    });
});
</script>
